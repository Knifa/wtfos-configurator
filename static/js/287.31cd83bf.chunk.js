!function(){"use strict";var e={9287:function(e,t,i){var n,r=i(5861),s=i(3433),a=i(5671),o=i(3144),d=i(7757),h=i.n(d);!function(e){var t;!function(e){e[e.FILE_IN=0]="FILE_IN",e[e.FILE_OUT=1]="FILE_OUT",e[e.PROGRESS_INIT=2]="PROGRESS_INIT",e[e.PROGRESS_UPDATE=3]="PROGRESS_UPDATE"}(t||(t={})),e.MessageType=t}(n||(n={}));var c=n,u=i(7762),f=i(70),l=i(7449);function p(e){var t=new l.StreamDataView(void 0,!0);t.setNextUint8(e.configurationVersion),t.setNextUint8(e.AVCProfileIndication),t.setNextUint8(e.profile_compatibility),t.setNextUint8(e.AVCLevelIndication),t.setNextUint8(e.lengthSizeMinusOne+252),t.setNextUint8(e.nb_SPS_nalus+224);for(var i=0;i<e.SPS.length;i++){t.setNextUint16(e.SPS[i].length);for(var n=0;n<e.SPS[i].length;n++)t.setNextUint8(e.SPS[i].nalu[n])}t.setNextUint8(e.nb_PPS_nalus);for(var r=0;r<e.PPS.length;r++){t.setNextUint16(e.PPS[r].length);for(var s=0;s<e.PPS[r].length;s++)t.setNextUint8(e.PPS[r].nalu[s])}if(e.ext)for(var a=0;a<e.ext.length;a++)t.setNextUint8(e.ext[a]);return t.getBuffer()}var m=function(){function e(t){(0,a.Z)(this,e),this.decoder=void 0,this.encoder=void 0,this.inFile=void 0,this.inInfo=void 0,this.outFile=void 0,this.expectedFrames=0,this.currentDecodingFrame=0,this.currentEncodingFrame=0,this.outTrackId=void 0,this.infoReady=void 0,this.modifyFrame=void 0,this.progressInit=void 0,this.progressUpdate=void 0,this.samples=[],this.infoReady=t.infoReady,this.modifyFrame=t.modifyFrame,this.progressInit=t.progressInit,this.progressUpdate=t.progressUpdate}return(0,o.Z)(e,[{key:"reset",value:function(){this.inFile=f.createFile(),this.inFile.onReady=this.onInInfoReady.bind(this),this.inFile.onSamples=this.onInSamples.bind(this),this.outFile=f.createFile(),this.encoder&&this.encoder.close(),this.encoder=new VideoEncoder({output:this.handleEncodedFrame.bind(this),error:this.handleEncoderError.bind(this)}),this.decoder&&this.decoder.close(),this.decoder=new VideoDecoder({output:this.handleDecodedFrame.bind(this),error:this.handleDecoderError.bind(this)}),this.samples=[]}},{key:"processFile",value:function(){var e=(0,r.Z)(h().mark((function e(t){var i,n,r,s,a,o,d;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.reset(),i=t.stream(),n=i.getReader(),r=0;case 4:return e.next=7,n.read();case 7:if(s=e.sent,a=s.done,o=s.value,!a){e.next=12;break}return e.abrupt("break",18);case 12:(d=o.buffer).fileStart=r,this.inFile.appendBuffer(d),r+=o.byteLength,e.next=4;break;case 18:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"processSamples",value:function(e){if(!this.inInfo)throw new Error("No info?");this.encoder.configure({codec:"avc1.42003d",width:e.width,height:e.height,bitrate:this.inInfo.videoTracks[0].bitrate,framerate:60,latencyMode:"realtime"}),this.expectedFrames=this.inInfo.videoTracks[0].nb_samples,this.currentDecodingFrame=0,this.currentEncodingFrame=0,this.progressInit(this.expectedFrames),this.inFile.setExtractionOptions(this.inInfo.videoTracks[0].id,void 0,{nbSamples:1,rapAlignement:!1}),this.inFile.start(),this.inFile.flush()}},{key:"onInInfoReady",value:function(e){this.inInfo=e,this.decoder.configure({codec:e.videoTracks[0].codec,codedWidth:e.videoTracks[0].track_width,codedHeight:e.videoTracks[0].track_height,description:p(this.inFile.moov.traks[0].mdia.minf.stbl.stsd.entries[0].avcC),optimizeForLatency:!0}),this.infoReady(e)}},{key:"onInSamples",value:function(e,t,i){var n,r=(0,u.Z)(i);try{for(r.s();!(n=r.n()).done;){var s=n.value;this.samples.push(s)}}catch(a){r.e(a)}finally{r.f()}this.samples.length===this.expectedFrames&&this.decodeNextSample()}},{key:"decodeNextSample",value:function(){var e=this.samples.shift();if(e){var t=new EncodedVideoChunk({data:e.data,duration:Math.floor(e.duration/e.timescale*1e6),timestamp:Math.floor(e.dts/e.timescale*1e6),type:e.is_sync?"key":"delta"});this.decoder.decode(t)}else console.error("No sample?")}},{key:"handleDecodedFrame",value:function(e){var t=this,i=this.modifyFrame(e,this.currentDecodingFrame);e.close(),this.currentDecodingFrame%60===0&&this.encoder.flush(),this.encoder.encode(i,{keyFrame:this.currentDecodingFrame%60===0}),this.currentDecodingFrame%60===0&&createImageBitmap(i).then((function(e){t.progressUpdate(void 0,e)})),this.currentDecodingFrame++,this.inFile.releaseUsedSamples(this.inInfo.videoTracks[0].id,this.currentDecodingFrame),i.close()}},{key:"handleDecoderError",value:function(e){throw e}},{key:"handleEncodedFrame",value:function(e,t){var i;this.outTrackId||(this.outTrackId=this.outFile.addTrack({avcDecoderConfigRecord:null===(i=t.decoderConfig)||void 0===i?void 0:i.description,height:this.inInfo.videoTracks[0].track_height,nb_samples:this.inInfo.videoTracks[0].nb_samples,timescale:this.inInfo.videoTracks[0].timescale,width:this.inInfo.videoTracks[0].track_width}));var n=new ArrayBuffer(e.byteLength);if(e.copyTo(n),this.outFile.addSample(this.outTrackId,n,{cts:this.currentEncodingFrame,dts:this.currentEncodingFrame,duration:1,is_sync:"key"===e.type}),this.progressUpdate(this.currentEncodingFrame),this.currentEncodingFrame++,this.currentEncodingFrame===this.expectedFrames){var r=this.outFile.getBuffer();postMessage({type:c.MessageType.FILE_OUT,buffer:r},[r])}else this.decodeNextSample()}},{key:"handleEncoderError",value:function(e){console.error(e)}}]),e}(),v=256,g=function(){function e(t,i){(0,a.Z)(this,e),this.name=void 0,this.tiles=void 0,this.name=t,this.tiles=i}return(0,o.Z)(e,[{key:"getTile",value:function(e){return this.tiles[e]}}],[{key:"fromFile",value:function(){var t=(0,r.Z)(h().mark((function t(i){var n,r,s,a,o,d,c,u,f;return h().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,i.arrayBuffer();case 2:n=t.sent,r=i.name.includes("hd"),s=r?24:36,a=r?36:54,o=[],d=0;case 8:if(!(d<v)){t.next=18;break}return c=new Uint8ClampedArray(n,d*s*a*4,s*a*4),u=new ImageData(c,s,a),t.next=13,createImageBitmap(u);case 13:f=t.sent,o.push(f);case 15:d++,t.next=8;break;case 18:return t.abrupt("return",new e(i.name,o));case 19:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()},{key:"fromFiles",value:function(){var t=(0,r.Z)(h().mark((function t(i){var n,r;return h().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=i.map((function(t){return e.fromFile(t)})),t.next=3,Promise.all(n);case 3:return r=t.sent,t.abrupt("return",{sd1:r.find((function(e){return!e.name.includes("_2")&&!e.name.includes("hd")})),sd2:r.find((function(e){return e.name.includes("_2")&&!e.name.includes("hd")})),hd1:r.find((function(e){return!e.name.includes("_2")&&e.name.includes("hd")})),hd2:r.find((function(e){return e.name.includes("_2")&&e.name.includes("hd")}))});case 5:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()}]),e}(),y=function(){function e(t){(0,a.Z)(this,e),this.header=void 0,this.frames=[];var i=new l.StreamDataView(t);for(this.header={magic:i.getNextString(7),version:i.getNextUint16(),config:{charWidth:i.getNextUint8(),charHeight:i.getNextUint8(),fontWidth:i.getNextUint8(),fontHeight:i.getNextUint8(),xOffset:i.getNextUint16(),yOffset:i.getNextUint16(),fontVariant:i.getNextUint8()}},31===this.header.config.charWidth&&(this.header.config.charWidth=30);i.getOffset()<t.byteLength;){var n=i.getNextUint32(),r=i.getNextUint32(),s=new Uint16Array(t,i.getOffset(),r);i.setOffset(i.getOffset()+2*r),this.frames.push({frameNumber:n,frameSize:r,frameData:s})}}return(0,o.Z)(e,null,[{key:"fromFile",value:function(){var t=(0,r.Z)(h().mark((function t(i){var n;return h().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,i.arrayBuffer();case 2:return n=t.sent,t.abrupt("return",new e(n));case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()}]),e}(),k=function(){function e(){(0,a.Z)(this,e),this.processor=void 0,this.fontPack=void 0,this.osdReader=void 0,this.lastOsdIndex=0,this.wide=!1,this.hd=!1,this.outWidth=void 0,this.outHeight=void 0,this.osdCanvas=void 0,this.osdCtx=void 0,this.frameCanvas=void 0,this.frameCtx=void 0,this.processor=new m({infoReady:this.infoReady.bind(this),modifyFrame:this.modifyFrame.bind(this),progressInit:this.progressInit.bind(this),progressUpdate:this.progressUpdate.bind(this)}),addEventListener("message",this.onMessage.bind(this))}return(0,o.Z)(e,[{key:"infoReady",value:function(e){var t,i,n=e.videoTracks[0].track_width,r=e.videoTracks[0].track_height;1280===n&&720===r&&(this.wide=!0),24===this.osdReader.header.config.fontWidth&&(this.hd=!0),this.wide||this.hd?(t=1280,i=720):(t=n,i=r),this.outWidth=t,this.outHeight=i,this.osdCanvas=new OffscreenCanvas(this.osdReader.header.config.fontWidth*this.osdReader.header.config.charWidth,this.osdReader.header.config.fontHeight*this.osdReader.header.config.charHeight),this.osdCtx=this.osdCanvas.getContext("2d"),this.frameCanvas=new OffscreenCanvas(this.outWidth,this.outHeight),this.frameCtx=this.frameCanvas.getContext("2d"),this.processor.processSamples({width:t,height:i})}},{key:"modifyFrame",value:function(e,t){var i,n=this.osdCanvas,r=this.osdCtx,s=this.frameCanvas,a=this.frameCtx;if(a.fillStyle="black",a.fillRect(0,0,s.width,s.height),r.clearRect(0,0,n.width,n.height),i=this.hd||this.wide?(this.outWidth-e.displayWidth)/2:0,a.drawImage(e,i,0),this.lastOsdIndex<this.osdReader.frames.length-1){var o=this.lastOsdIndex+1;t>=this.osdReader.frames[o].frameNumber&&(this.lastOsdIndex=o)}for(var d=this.osdReader.frames[this.lastOsdIndex],h=0;h<22;h++)for(var c=0;c<60;c++){var u=h+22*c,f=d.frameData[u],l=void 0;l=this.hd?f<v?this.fontPack.hd1:this.fontPack.hd2:f<v?this.fontPack.sd1:this.fontPack.sd2,r.drawImage(l.getTile(f%v),c*this.osdReader.header.config.fontWidth,h*this.osdReader.header.config.fontHeight)}var p=s.height/n.height,m=n.width*p,g=n.height*p,y=(s.width-m)/2,k=(s.height-g)/2;return a.drawImage(n,y,k,m,g),new VideoFrame(s,{timestamp:e.timestamp})}},{key:"progressInit",value:function(e){postMessage({type:c.MessageType.PROGRESS_INIT,expectedFrames:e})}},{key:"progressUpdate",value:function(e,t){postMessage({type:c.MessageType.PROGRESS_UPDATE,currentFrame:e,preview:t},(0,s.Z)(t?[t]:[]))}},{key:"onMessage",value:function(){var e=(0,r.Z)(h().mark((function e(t){var i;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=t.data,e.t0=i.type,e.next=e.t0===c.MessageType.FILE_IN?4:16;break;case 4:return console.debug("Hello from the worker!"),e.next=7,y.fromFile(i.osdFile);case 7:return this.osdReader=e.sent,console.debug("Got OSD reader"),e.next=11,g.fromFiles(i.fontFiles);case 11:return this.fontPack=e.sent,console.debug("Got font pack"),console.debug("Starting processor..."),this.processor.processFile(i.videoFile),e.abrupt("break",17);case 16:throw new Error("Unknown message type received");case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}();new k}},t={};function i(n){var r=t[n];if(void 0!==r)return r.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,i),s.exports}i.m=e,i.x=function(){var e=i.O(void 0,[16],(function(){return i(9287)}));return e=i.O(e)},function(){var e=[];i.O=function(t,n,r,s){if(!n){var a=1/0;for(c=0;c<e.length;c++){n=e[c][0],r=e[c][1],s=e[c][2];for(var o=!0,d=0;d<n.length;d++)(!1&s||a>=s)&&Object.keys(i.O).every((function(e){return i.O[e](n[d])}))?n.splice(d--,1):(o=!1,s<a&&(a=s));if(o){e.splice(c--,1);var h=r();void 0!==h&&(t=h)}}return t}s=s||0;for(var c=e.length;c>0&&e[c-1][2]>s;c--)e[c]=e[c-1];e[c]=[n,r,s]}}(),i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,{a:t}),t},i.d=function(e,t){for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.f={},i.e=function(e){return Promise.all(Object.keys(i.f).reduce((function(t,n){return i.f[n](e,t),t}),[]))},i.u=function(e){return"static/js/"+e+".57fd4f51.chunk.js"},i.miniCssF=function(e){},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",function(){var e={287:1};i.f.i=function(t,n){e[t]||importScripts(i.p+i.u(t))};var t=self.webpackChunkwtfos_configurator=self.webpackChunkwtfos_configurator||[],n=t.push.bind(t);t.push=function(t){var r=t[0],s=t[1],a=t[2];for(var o in s)i.o(s,o)&&(i.m[o]=s[o]);for(a&&a(i);r.length;)e[r.pop()]=1;n(t)}}(),function(){var e=i.x;i.x=function(){return i.e(16).then(e)}}();i.x()}();
//# sourceMappingURL=287.31cd83bf.chunk.js.map