!function(){"use strict";var e={9287:function(e,t,i){var s,n=i(5861),r=i(3433),o=i(5671),a=i(3144),d=i(7757),h=i.n(d);!function(e){var t;!function(e){e[e.FILE_IN=0]="FILE_IN",e[e.FILE_OUT=1]="FILE_OUT",e[e.PROGRESS_INIT=2]="PROGRESS_INIT",e[e.PROGRESS_UPDATE=3]="PROGRESS_UPDATE"}(t||(t={})),e.MessageType=t}(s||(s={}));var c=s,f=i(7762),u=i(70),l=i(7449);function m(e){var t=new l.StreamDataView(void 0,!0);t.setNextUint8(e.configurationVersion),t.setNextUint8(e.AVCProfileIndication),t.setNextUint8(e.profile_compatibility),t.setNextUint8(e.AVCLevelIndication),t.setNextUint8(e.lengthSizeMinusOne+252),t.setNextUint8(e.nb_SPS_nalus+224);for(var i=0;i<e.SPS.length;i++){t.setNextUint16(e.SPS[i].length);for(var s=0;s<e.SPS[i].length;s++)t.setNextUint8(e.SPS[i].nalu[s])}t.setNextUint8(e.nb_PPS_nalus);for(var n=0;n<e.PPS.length;n++){t.setNextUint16(e.PPS[n].length);for(var r=0;r<e.PPS[n].length;r++)t.setNextUint8(e.PPS[n].nalu[r])}if(e.ext)for(var o=0;o<e.ext.length;o++)t.setNextUint8(e.ext[o]);return t.getBuffer()}var p=function(){function e(t){(0,o.Z)(this,e),this.decoder=void 0,this.encoder=void 0,this.inFile=void 0,this.inInfo=void 0,this.outFile=void 0,this.expectedFrames=0,this.framesDecoded=0,this.framesEncoded=0,this.queuedForDecode=0,this.queuedForEncode=0,this.outTrackId=void 0,this.infoReady=void 0,this.modifyFrame=void 0,this.progressInit=void 0,this.progressUpdate=void 0,this.samples=[],this.infoReady=t.infoReady,this.modifyFrame=t.modifyFrame,this.progressInit=t.progressInit,this.progressUpdate=t.progressUpdate}return(0,a.Z)(e,[{key:"reset",value:function(){this.inFile=u.createFile(),this.inFile.onReady=this.onInInfoReady.bind(this),this.inFile.onSamples=this.onInSamples.bind(this),this.inFile.onError=this.onInError.bind(this),this.outFile=u.createFile(),this.outTrackId=void 0,this.encoder&&this.encoder.close(),this.encoder=new VideoEncoder({output:this.handleEncodedFrame.bind(this),error:this.handleEncoderError.bind(this)}),this.decoder&&this.decoder.close(),this.decoder=new VideoDecoder({output:this.handleDecodedFrame.bind(this),error:this.handleDecoderError.bind(this)}),this.samples=[]}},{key:"processFile",value:function(){var e=(0,n.Z)(h().mark((function e(t){var i,s,n,r,o,a,d;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.reset(),i=t.stream(),s=i.getReader(),n=0;case 4:return e.next=7,s.read();case 7:if(r=e.sent,o=r.done,a=r.value,!o){e.next=12;break}return e.abrupt("break",18);case 12:(d=a.buffer).fileStart=n,this.inFile.appendBuffer(d),n+=a.byteLength,e.next=4;break;case 18:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"processSamples",value:function(e){if(!this.inInfo)throw new Error("No info?");this.encoder.configure({codec:"avc1.42003d",width:e.width,height:e.height,bitrate:this.inInfo.videoTracks[0].bitrate,framerate:60,latencyMode:"quality"}),this.expectedFrames=this.inInfo.videoTracks[0].nb_samples,this.framesDecoded=0,this.framesEncoded=0,this.progressInit(this.expectedFrames),this.inFile.setExtractionOptions(this.inInfo.videoTracks[0].id,void 0,{nbSamples:1,rapAlignement:!1}),this.inFile.start(),this.inFile.flush()}},{key:"onInInfoReady",value:function(e){this.inInfo=e,this.decoder.configure({codec:e.videoTracks[0].codec,codedWidth:e.videoTracks[0].track_width,codedHeight:e.videoTracks[0].track_height,description:m(this.inFile.moov.traks[0].mdia.minf.stbl.stsd.entries[0].avcC),optimizeForLatency:!1}),this.infoReady(e)}},{key:"onInSamples",value:function(e,t,i){var s,n=(0,f.Z)(i);try{for(n.s();!(s=n.n()).done;){var r=s.value;r.size<=100?(console.warn("Tiny frame (number: ".concat(r.number,", ").concat(r.size," bytes) detected, skipping.")),this.expectedFrames--):this.samples.push(r)}}catch(o){n.e(o)}finally{n.f()}this.samples.length===this.expectedFrames&&this.decodeNextSamples()}},{key:"decodeNextSamples",value:function(){if(!(this.decoder.decodeQueueSize>=30||this.encoder.encodeQueueSize>=30)||this.samples.length<30){var e=this.samples.shift();if(!e)throw Error("Tried to pull sample from queue but queue is empty!");var t=new EncodedVideoChunk({data:e.data,duration:Math.floor(e.duration/e.timescale*1e6),timestamp:Math.floor(e.dts/e.timescale*1e6),type:e.is_sync?"key":"delta"});this.decoder.decode(t),this.queuedForDecode++,this.samples.length>0&&!this.samples[0].is_sync?this.decodeNextSamples():(console.debug("Flushing decoder at decoded frame ".concat(this.framesDecoded)),this.decoder.flush())}}},{key:"handleDecodedFrame",value:function(e){var t=this;this.framesDecoded%60===0&&(console.debug("Flushing encoder at decoded frame ".concat(this.framesDecoded,", keyframe incoming.")),this.encoder.flush());var i=this.modifyFrame(e,this.framesDecoded);e.close(),this.encoder.encode(i,{keyFrame:this.framesDecoded%60===0}),this.queuedForEncode++,this.framesDecoded%60===0&&createImageBitmap(i).then((function(e){t.progressUpdate(void 0,e)})),i.close(),this.framesDecoded++,this.inFile.releaseUsedSamples(this.inInfo.videoTracks[0].id,this.framesDecoded),this.framesDecoded===this.expectedFrames&&(console.debug("Flushing encoder at decoded frame ".concat(this.framesDecoded,", last frame.")),this.encoder.flush())}},{key:"handleEncodedFrame",value:function(e,t){var i;this.outTrackId||(this.outTrackId=this.outFile.addTrack({avcDecoderConfigRecord:null===(i=t.decoderConfig)||void 0===i?void 0:i.description,height:this.inInfo.videoTracks[0].track_height,nb_samples:this.inInfo.videoTracks[0].nb_samples,timescale:this.inInfo.videoTracks[0].timescale,width:this.inInfo.videoTracks[0].track_width}));var s=new ArrayBuffer(e.byteLength);if(e.copyTo(s),this.outFile.addSample(this.outTrackId,s,{cts:this.framesEncoded,dts:this.framesEncoded,duration:1,is_sync:"key"===e.type}),this.progressUpdate(this.framesEncoded),this.framesEncoded++,this.framesEncoded===this.expectedFrames){var n=this.outFile.getBuffer();if(0===n.byteLength)throw Error("Output buffer is empty!?");postMessage({type:c.MessageType.FILE_OUT,buffer:n},[n])}else this.samples.length>0&&this.decodeNextSamples()}},{key:"onInError",value:function(e){throw e}},{key:"handleDecoderError",value:function(e){throw e}},{key:"handleEncoderError",value:function(e){throw e}}]),e}(),v=256,g=function(){function e(t,i){(0,o.Z)(this,e),this.name=void 0,this.tiles=void 0,this.name=t,this.tiles=i}return(0,a.Z)(e,[{key:"getTile",value:function(e){return this.tiles[e]}}],[{key:"fromFile",value:function(){var t=(0,n.Z)(h().mark((function t(i){var s,n,r,o,a,d,c,f,u;return h().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,i.arrayBuffer();case 2:s=t.sent,n=i.name.includes("hd"),r=n?24:36,o=n?36:54,a=[],d=0;case 8:if(!(d<v)){t.next=18;break}return c=new Uint8ClampedArray(s,d*r*o*4,r*o*4),f=new ImageData(c,r,o),t.next=13,createImageBitmap(f);case 13:u=t.sent,a.push(u);case 15:d++,t.next=8;break;case 18:return t.abrupt("return",new e(i.name,a));case 19:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()},{key:"fromFiles",value:function(){var t=(0,n.Z)(h().mark((function t(i){var s,n;return h().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return s=i.map((function(t){return e.fromFile(t)})),t.next=3,Promise.all(s);case 3:return n=t.sent,t.abrupt("return",{sd1:n.find((function(e){return!e.name.includes("_2")&&!e.name.includes("hd")})),sd2:n.find((function(e){return e.name.includes("_2")&&!e.name.includes("hd")})),hd1:n.find((function(e){return!e.name.includes("_2")&&e.name.includes("hd")})),hd2:n.find((function(e){return e.name.includes("_2")&&e.name.includes("hd")}))});case 5:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()}]),e}(),y=function(){function e(t){(0,o.Z)(this,e),this.header=void 0,this.frames=[];var i=new l.StreamDataView(t);for(this.header={magic:i.getNextString(7),version:i.getNextUint16(),config:{charWidth:i.getNextUint8(),charHeight:i.getNextUint8(),fontWidth:i.getNextUint8(),fontHeight:i.getNextUint8(),xOffset:i.getNextUint16(),yOffset:i.getNextUint16(),fontVariant:i.getNextUint8()}},31===this.header.config.charWidth&&(this.header.config.charWidth=30);i.getOffset()<t.byteLength;)try{var s=i.getNextUint32(),n=i.getNextUint32(),r=new Uint16Array(t,i.getOffset(),n);i.setOffset(i.getOffset()+2*n),this.frames.push({frameNumber:s,frameSize:n,frameData:r})}catch(a){if(a instanceof RangeError){console.warn("No more data in OSD file, probably truncated due to power loss");break}}}return(0,a.Z)(e,null,[{key:"fromFile",value:function(){var t=(0,n.Z)(h().mark((function t(i){var s;return h().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,i.arrayBuffer();case 2:return s=t.sent,t.abrupt("return",new e(s));case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()}]),e}(),k=function(){function e(){(0,o.Z)(this,e),this.processor=void 0,this.fontPack=void 0,this.osdReader=void 0,this.lastOsdIndex=0,this.wide=!1,this.hd=!1,this.outWidth=void 0,this.outHeight=void 0,this.osdCanvas=void 0,this.osdCtx=void 0,this.frameCanvas=void 0,this.frameCtx=void 0,this.processor=new p({infoReady:this.infoReady.bind(this),modifyFrame:this.modifyFrame.bind(this),progressInit:this.progressInit.bind(this),progressUpdate:this.progressUpdate.bind(this)}),addEventListener("message",this.onMessage.bind(this))}return(0,a.Z)(e,[{key:"infoReady",value:function(e){var t,i,s=e.videoTracks[0].track_width,n=e.videoTracks[0].track_height;1280===s&&720===n&&(this.wide=!0),24===this.osdReader.header.config.fontWidth&&(this.hd=!0),this.wide||this.hd?(t=1280,i=720):(t=s,i=n),this.outWidth=t,this.outHeight=i,this.osdCanvas=new OffscreenCanvas(this.osdReader.header.config.fontWidth*this.osdReader.header.config.charWidth,this.osdReader.header.config.fontHeight*this.osdReader.header.config.charHeight),this.osdCtx=this.osdCanvas.getContext("2d"),this.frameCanvas=new OffscreenCanvas(this.outWidth,this.outHeight),this.frameCtx=this.frameCanvas.getContext("2d"),this.processor.processSamples({width:t,height:i})}},{key:"modifyFrame",value:function(e,t){var i,s=this.osdCanvas,n=this.osdCtx,r=this.frameCanvas,o=this.frameCtx;if(o.fillStyle="black",o.fillRect(0,0,r.width,r.height),n.clearRect(0,0,s.width,s.height),i=this.hd||this.wide?(this.outWidth-e.displayWidth)/2:0,o.drawImage(e,i,0),this.lastOsdIndex<this.osdReader.frames.length-1){var a=this.lastOsdIndex+1;t>=this.osdReader.frames[a].frameNumber&&(this.lastOsdIndex=a)}for(var d=this.osdReader.frames[this.lastOsdIndex],h=0;h<22;h++)for(var c=0;c<60;c++){var f=h+22*c,u=d.frameData[f],l=void 0;l=this.hd?u<v?this.fontPack.hd1:this.fontPack.hd2:u<v?this.fontPack.sd1:this.fontPack.sd2,n.drawImage(l.getTile(u%v),c*this.osdReader.header.config.fontWidth,h*this.osdReader.header.config.fontHeight)}var m=r.height/s.height,p=s.width*m,g=s.height*m,y=(r.width-p)/2,k=(r.height-g)/2;return o.drawImage(s,y,k,p,g),new VideoFrame(r,{timestamp:e.timestamp})}},{key:"progressInit",value:function(e){postMessage({type:c.MessageType.PROGRESS_INIT,expectedFrames:e})}},{key:"progressUpdate",value:function(e,t){postMessage({type:c.MessageType.PROGRESS_UPDATE,currentFrame:e,preview:t},(0,r.Z)(t?[t]:[]))}},{key:"onMessage",value:function(){var e=(0,n.Z)(h().mark((function e(t){var i;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=t.data,e.t0=i.type,e.next=e.t0===c.MessageType.FILE_IN?4:16;break;case 4:return console.debug("Hello from the worker!"),e.next=7,y.fromFile(i.osdFile);case 7:return this.osdReader=e.sent,console.debug("Got OSD reader"),e.next=11,g.fromFiles(i.fontFiles);case 11:return this.fontPack=e.sent,console.debug("Got font pack"),console.debug("Starting processor..."),this.processor.processFile(i.videoFile),e.abrupt("break",17);case 16:throw new Error("Unknown message type received");case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}();new k}},t={};function i(s){var n=t[s];if(void 0!==n)return n.exports;var r=t[s]={exports:{}};return e[s].call(r.exports,r,r.exports,i),r.exports}i.m=e,i.x=function(){var e=i.O(void 0,[16],(function(){return i(9287)}));return e=i.O(e)},function(){var e=[];i.O=function(t,s,n,r){if(!s){var o=1/0;for(c=0;c<e.length;c++){s=e[c][0],n=e[c][1],r=e[c][2];for(var a=!0,d=0;d<s.length;d++)(!1&r||o>=r)&&Object.keys(i.O).every((function(e){return i.O[e](s[d])}))?s.splice(d--,1):(a=!1,r<o&&(o=r));if(a){e.splice(c--,1);var h=n();void 0!==h&&(t=h)}}return t}r=r||0;for(var c=e.length;c>0&&e[c-1][2]>r;c--)e[c]=e[c-1];e[c]=[s,n,r]}}(),i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,{a:t}),t},i.d=function(e,t){for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.f={},i.e=function(e){return Promise.all(Object.keys(i.f).reduce((function(t,s){return i.f[s](e,t),t}),[]))},i.u=function(e){return"static/js/"+e+".57fd4f51.chunk.js"},i.miniCssF=function(e){},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",function(){var e={287:1};i.f.i=function(t,s){e[t]||importScripts(i.p+i.u(t))};var t=self.webpackChunkwtfos_configurator=self.webpackChunkwtfos_configurator||[],s=t.push.bind(t);t.push=function(t){var n=t[0],r=t[1],o=t[2];for(var a in r)i.o(r,a)&&(i.m[a]=r[a]);for(o&&o(i);n.length;)e[n.pop()]=1;s(t)}}(),function(){var e=i.x;i.x=function(){return i.e(16).then(e)}}();i.x()}();
//# sourceMappingURL=287.995a450d.chunk.js.map